# 뭐입지 - 서비스 전체 플로우 문서

## 1. 서비스 개요

**뭐입지**는 AI 기반 패션 코디 추천 서비스입니다.

- **핵심 기능**: 4가지 질문으로 사용자 맞춤 코디 추천
- **데이터 소스**: 무신사 상품
- **차별점**: 누끼 처리된 이미지로 시각적 코디 조합 제공

---

## 2. 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     React Frontend (Vite + TS)                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │   │
│  │  │  Home   │ │  Quiz   │ │ Loading │ │ Result  │ │ MyPage  │       │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                                     │ HTTP/REST
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              SERVER LAYER                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Backend API (FastAPI)                          │   │
│  │                                                                     │   │
│  │   /api/recommend      AI 코디 추천                                   │   │
│  │   /api/products       상품 검색/조회                                  │   │
│  │   /api/process-image  이미지 누끼 처리                                │   │
│  │   /api/auth           인증 (로그인/회원가입)                           │   │
│  │   /api/subscription   구독 관리                                      │   │
│  │   /api/user           사용자 정보                                     │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐
│   EXTERNAL SERVICE  │ │   PROCESSING LAYER  │ │    DATA LAYER       │
│                     │ │                     │ │                     │
│  ┌───────────────┐  │ │  ┌───────────────┐  │ │  ┌───────────────┐  │
│  │   무신사 API   │  │ │  │  rembg        │  │ │  │  PostgreSQL   │  │
│  │   (크롤링)     │  │ │  │  (누끼처리)    │  │ │  │  (사용자/구독) │  │
│  └───────────────┘  │ │  └───────────────┘  │ │  └───────────────┘  │
│                     │ │                     │ │                     │
│  ┌───────────────┐  │ │  ┌───────────────┐  │ │  ┌───────────────┐  │
│  │   OpenAI API  │  │ │  │  Image Cache  │  │ │  │  Redis        │  │
│  │   (AI 추천)   │  │ │  │  (S3/Local)   │  │ │  │  (세션/캐시)   │  │
│  └───────────────┘  │ │  └───────────────┘  │ │  └───────────────┘  │
└─────────────────────┘ └─────────────────────┘ └─────────────────────┘
```

---

## 3. 사용자 여정 (User Journey)

### 3.1 전체 플로우 다이어그램

```
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│   Home   │───▶│   Quiz   │───▶│ Loading  │───▶│  Result  │───▶│ Purchase │
│  (메인)  │    │ (4질문)  │    │ (AI처리) │    │ (코디)   │    │ (무신사) │
└──────────┘    └──────────┘    └──────────┘    └──────────┘    └──────────┘
     │                                               │
     │                                               ▼
     │                                         ┌──────────┐
     │                                         │  MyPage  │
     │                                         │(저장코디)│
     │                                         └──────────┘
     │                                               │
     ▼                                               ▼
┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐
│  Login   │◀──▶│  Signup  │    │ Pricing  │───▶│ Payment  │
│ (로그인) │    │(회원가입)│    │ (구독플랜)│    │  (결제)  │
└──────────┘    └──────────┘    └──────────┘    └──────────┘
```

### 3.2 상세 사용자 시나리오

#### 시나리오 1: 신규 사용자 (무료 체험)

```
1. Home 접속
   └─▶ "코디 추천 받기" 클릭

2. Quiz 진행 (비로그인)
   ├─▶ Q1: 어디 가요? → "데이트" 선택
   ├─▶ Q2: 어떻게 보이고 싶어요? → "멋있게" 선택
   ├─▶ Q3: 체형 고민? → "없음" 선택
   └─▶ Q4: 예산은? → "20만원" 선택

3. Loading 화면
   └─▶ AI 분석 중... (3-5초)

4. Result 화면
   ├─▶ 추천 코디 확인 (상의, 하의, 신발)
   ├─▶ "저장하기" 클릭 → 로그인 유도
   └─▶ 회원가입 진행

5. Signup 화면
   └─▶ 이메일/비밀번호 입력 → 가입 완료
       └─▶ 무료 5회 이용권 자동 부여

6. Result 화면 (재진입)
   └─▶ 코디 저장 완료
       └─▶ MyPage에서 확인 가능
```

#### 시나리오 2: 기존 사용자 (유료 구독)

```
1. Login
   └─▶ 이메일/비밀번호 입력

2. Home (로그인 상태)
   └─▶ 네비게이션에 사용자 이름 표시

3. Quiz → Loading → Result
   └─▶ 추천 코디 확인

4. Result 화면
   ├─▶ "저장하기" → 즉시 저장
   ├─▶ "다시 추천받기" → Quiz로
   └─▶ "구매하기" → 무신사 페이지로 이동

5. MyPage
   ├─▶ 저장한 코디 목록 확인
   ├─▶ 구독 정보 확인
   └─▶ 코디 삭제 가능
```

---

## 4. 화면별 상세 플로우

### 4.1 Home → Quiz

```
[Home]
  │
  ├─▶ "코디 추천 받기" 버튼 클릭
  │     └─▶ navigate('/quiz')
  │
  ├─▶ "무료로 시작하기" 버튼 클릭 (비로그인)
  │     └─▶ navigate('/signup')
  │
  └─▶ "로그인" 버튼 클릭
        └─▶ navigate('/login')
```

### 4.2 Quiz Flow

```
[Quiz - Q1: 어디 가요?]
  │
  │  옵션: 학교, 회사, 데이트, 외출
  │
  └─▶ 선택 시 → currentQuestion++
        │
        ▼
[Quiz - Q2: 어떻게 보이고 싶어요?]
  │
  │  옵션: 깔끔하게, 편하게, 멋있게, 독특하게
  │
  └─▶ 선택 시 → currentQuestion++
        │
        ▼
[Quiz - Q3: 체형 고민?]
  │
  │  옵션: 없음, 배, 마른편, 키
  │
  └─▶ 선택 시 → currentQuestion++
        │
        ▼
[Quiz - Q4: 예산은?]
  │
  │  옵션: 10만원, 20만원, 30만원, 무관
  │
  └─▶ 선택 시 → navigate('/loading', { state: answers })
```

### 4.3 Loading → Result

```
[Loading]
  │
  │  1. 퀴즈 답변 데이터 수신 (state)
  │  2. API 호출: POST /api/recommend
  │  3. 로딩 애니메이션 표시 (최소 3초)
  │
  └─▶ 응답 수신 시
        │
        ├─▶ 성공: navigate('/result', { state: recommendation })
        │
        └─▶ 실패: 에러 토스트 → 재시도 버튼 표시
```

### 4.4 Result 액션

```
[Result]
  │
  ├─▶ "저장하기" 버튼
  │     ├─▶ 로그인 상태: AuthContext.saveOutfit()
  │     │     └─▶ 토스트: "코디가 저장되었습니다"
  │     │
  │     └─▶ 비로그인: navigate('/login', { state: { from: '/result' } })
  │
  ├─▶ "다시 추천받기" 버튼
  │     └─▶ navigate('/quiz')
  │
  ├─▶ 개별 아이템 "구매하기" 버튼
  │     └─▶ window.open(item.musinsaLink, '_blank')
  │
  └─▶ "전체 구매하기" 버튼
        └─▶ 각 아이템 무신사 링크 새 탭 오픈
```

---

## 5. 데이터 플로우

### 5.1 인증 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                      Authentication Flow                    │
└─────────────────────────────────────────────────────────────┘

[회원가입]
  Client                    Server                    DB
    │                         │                        │
    ├── POST /api/auth/signup ─▶                       │
    │   { email, password, name }                      │
    │                         │                        │
    │                         ├── 이메일 중복 체크 ─────▶│
    │                         │◀── 결과 ───────────────┤
    │                         │                        │
    │                         ├── 비밀번호 해시화        │
    │                         │                        │
    │                         ├── 사용자 생성 ─────────▶│
    │                         │   + 무료 5회 이용권     │
    │                         │                        │
    │◀── { token, user } ─────┤                        │
    │                         │                        │

[로그인]
  Client                    Server                    DB
    │                         │                        │
    ├── POST /api/auth/login ─▶                        │
    │   { email, password }   │                        │
    │                         │                        │
    │                         ├── 사용자 조회 ─────────▶│
    │                         │◀── 사용자 정보 ────────┤
    │                         │                        │
    │                         ├── 비밀번호 검증         │
    │                         │                        │
    │                         ├── JWT 토큰 생성         │
    │                         │                        │
    │◀── { token, user } ─────┤                        │
    │                         │                        │
```

### 5.2 코디 추천 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                    Recommendation Flow                      │
└─────────────────────────────────────────────────────────────┘

  Client              Server              무신사             AI(OpenAI)
    │                   │                   │                   │
    ├── POST /api/recommend ─▶              │                   │
    │   { occasion, style,                  │                   │
    │     bodyConcern, budget }             │                   │
    │                   │                   │                   │
    │                   ├── 상품 검색 ───────▶                   │
    │                   │   (상의, 하의, 신발)                   │
    │                   │◀── 상품 목록 ──────┤                   │
    │                   │                   │                   │
    │                   ├── AI 코디 추천 요청 ──────────────────▶│
    │                   │   (사용자 조건 + 상품 목록)             │
    │                   │◀── 추천 조합 ────────────────────────┤
    │                   │                   │                   │
    │                   ├── 누끼 처리 (rembg)                    │
    │                   │   (선택된 상품 이미지)                  │
    │                   │                   │                   │
    │◀── 추천 결과 ─────┤                   │                   │
    │   { top, bottom, shoes,               │                   │
    │     processedImages }                 │                   │
    │                   │                   │                   │
```

### 5.3 구독 결제 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                     Subscription Flow                       │
└─────────────────────────────────────────────────────────────┘

  Client              Server              결제(토스/카카오)    DB
    │                   │                       │              │
    ├── 플랜 선택 ───────▶                       │              │
    │   (Basic/Pro)     │                       │              │
    │                   │                       │              │
    │◀── 결제 위젯 URL ──┤                       │              │
    │                   │                       │              │
    ├── 결제 진행 ───────────────────────────────▶              │
    │   (카드 정보)      │                       │              │
    │                   │                       │              │
    │                   │◀── 결제 완료 웹훅 ─────┤              │
    │                   │                       │              │
    │                   ├── 구독 정보 업데이트 ─────────────────▶│
    │                   │   (plan, startDate, endDate)         │
    │                   │                       │              │
    │◀── 구독 완료 ──────┤                       │              │
    │                   │                       │              │
```

---

## 6. API 명세

### 6.1 인증 API

| Endpoint | Method | Description | Request | Response |
|----------|--------|-------------|---------|----------|
| `/api/auth/signup` | POST | 회원가입 | `{ email, password, name }` | `{ token, user }` |
| `/api/auth/login` | POST | 로그인 | `{ email, password }` | `{ token, user }` |
| `/api/auth/logout` | POST | 로그아웃 | - | `{ success }` |
| `/api/auth/me` | GET | 내 정보 조회 | - | `{ user }` |

### 6.2 추천 API

| Endpoint | Method | Description | Request | Response |
|----------|--------|-------------|---------|----------|
| `/api/recommend` | POST | 코디 추천 | `{ occasion, style, bodyConcern, budget }` | `{ top, bottom, shoes, totalPrice }` |
| `/api/recommend/save` | POST | 코디 저장 | `{ outfitId }` | `{ success }` |
| `/api/recommend/history` | GET | 추천 이력 | - | `{ recommendations[] }` |

### 6.3 상품 API

| Endpoint | Method | Description | Request | Response |
|----------|--------|-------------|---------|----------|
| `/api/products/search` | GET | 상품 검색 | `?keyword=&minPrice=&maxPrice=` | `{ products[] }` |
| `/api/products/:id` | GET | 상품 상세 | - | `{ product }` |
| `/api/products/:id/image` | GET | 누끼 이미지 | - | `image/png` |

### 6.4 구독 API

| Endpoint | Method | Description | Request | Response |
|----------|--------|-------------|---------|----------|
| `/api/subscription/plans` | GET | 플랜 목록 | - | `{ plans[] }` |
| `/api/subscription/subscribe` | POST | 구독 신청 | `{ planId, paymentMethod }` | `{ paymentUrl }` |
| `/api/subscription/cancel` | POST | 구독 취소 | - | `{ success }` |
| `/api/subscription/status` | GET | 구독 상태 | - | `{ subscription }` |

---

## 7. 상태 관리 (State Management)

### 7.1 AuthContext 상태

```typescript
interface AuthState {
  // 사용자 정보
  user: User | null;

  // 저장된 코디
  savedOutfits: SavedOutfit[];

  // 구독 정보
  subscription: {
    plan: "free" | "basic" | "pro";
    isActive: boolean;
    startDate: string | null;
    endDate: string | null;
    remainingCredits: number;  // 무료 이용권
  };
}

interface User {
  id: string;
  email: string;
  name: string;
  createdAt: string;
}

interface SavedOutfit {
  id: string;
  date: string;
  top: Product;
  bottom: Product;
  shoes: Product;
  total: number;
}
```

### 7.2 Quiz 상태

```typescript
interface QuizState {
  currentQuestion: number;  // 0-3
  answers: {
    occasion: string | null;     // Q1
    style: string | null;        // Q2
    bodyConcern: string | null;  // Q3
    budget: number | null;       // Q4
  };
}
```

---

## 8. 에러 처리

### 8.1 에러 코드

| Code | Message | 설명 |
|------|---------|------|
| `AUTH_001` | Invalid credentials | 잘못된 이메일/비밀번호 |
| `AUTH_002` | Email already exists | 이메일 중복 |
| `AUTH_003` | Token expired | 토큰 만료 |
| `SUB_001` | No active subscription | 구독 없음 |
| `SUB_002` | Credit exhausted | 이용권 소진 |
| `REC_001` | Recommendation failed | 추천 실패 |
| `IMG_001` | Image processing failed | 이미지 처리 실패 |

### 8.2 에러 처리 플로우

```
[API 에러 발생]
  │
  ├─▶ 401 Unauthorized
  │     └─▶ 토큰 갱신 시도
  │           ├─▶ 성공: 원래 요청 재시도
  │           └─▶ 실패: 로그인 페이지로 이동
  │
  ├─▶ 403 Forbidden (SUB_001, SUB_002)
  │     └─▶ Pricing 페이지로 이동
  │
  ├─▶ 500 Server Error
  │     └─▶ 에러 토스트 + 재시도 버튼
  │
  └─▶ Network Error
        └─▶ 오프라인 안내 + 재연결 시 자동 재시도
```

---

## 9. 보안 고려사항

### 9.1 인증/인가

- JWT 토큰 사용 (Access Token + Refresh Token)
- Access Token: 15분 만료
- Refresh Token: 7일 만료, httpOnly 쿠키 저장
- 비밀번호: bcrypt 해시화

### 9.2 API 보안

- Rate Limiting: 100 req/min per IP
- CORS: 허용된 origin만 접근
- Input Validation: Pydantic 스키마 검증
- SQL Injection 방지: ORM 사용

### 9.3 결제 보안

- PCI DSS 준수 결제 게이트웨이 사용
- 카드 정보 서버 미저장
- 웹훅 서명 검증

---

## 10. 성능 최적화

### 10.1 프론트엔드

- 이미지 lazy loading
- React.memo로 불필요한 리렌더링 방지
- 코드 스플리팅 (React.lazy)

### 10.2 백엔드

- 누끼 이미지 캐싱 (Redis/S3)
- 상품 검색 결과 캐싱 (5분 TTL)
- 비동기 이미지 처리 (Celery)

### 10.3 인프라

- CDN을 통한 정적 자원 서빙
- 데이터베이스 인덱싱
- 로드 밸런싱

---

## 11. 모니터링

### 11.1 로깅

```python
# 로그 레벨
- INFO: API 요청/응답
- WARNING: 비정상 동작 (재시도 등)
- ERROR: 처리 실패
- DEBUG: 상세 디버그 정보
```

### 11.2 메트릭

- API 응답 시간
- 추천 성공률
- 이미지 처리 시간
- 활성 사용자 수
- 구독 전환율

---

## 12. 향후 로드맵

### Phase 1 (MVP)
- [x] 프론트엔드 UI 구현
- [ ] 백엔드 API 구현
- [ ] 무신사 크롤링 연동
- [ ] 누끼 처리 파이프라인

### Phase 2 (Growth)
- [ ] AI 추천 알고리즘 고도화
- [ ] 사용자 취향 학습
- [ ] 소셜 로그인 (카카오, 네이버)
- [ ] 푸시 알림

### Phase 3 (Scale)
- [ ] 다른 쇼핑몰 연동 (29CM, W컨셉)
- [ ] 커뮤니티 기능
- [ ] 인플루언서 코디 공유
